<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weather Station</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f172a;--card:#0b1220;--muted:#9aa6bf;--accent1:#fb7185;--accent2:#60a5fa}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
  body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071027 0%, #07142a 100%);color:#e6eef8}
  .wrap{width:min(920px,94vw);padding:28px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .title{display:flex;gap:14px;align-items:center}
  .title h1{font-size:20px;margin:0;font-weight:600}
  .status{font-size:13px;color:var(--muted)}
  .values{display:flex;gap:10px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:10px 14px;border-radius:999px;min-width:96px;text-align:center}
  .pill .big{font-size:18px;font-weight:600}
  canvas{width:100%;height:320px}
  @media (max-width:640px){canvas{height:260px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M3 12a4.5 4.5 0 0 0 9 0 4.5 4.5 0 0 0 9 0" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round"/></svg>
        <div>
          <h1>Weather Station</h1>
          <div class="status" id="updated">—</div>
        </div>
      </div>
      <div class="values">
        <div class="pill"><div class="big" id="temp">-- °C</div><div style="font-size:12px;color:var(--muted)">Temperature</div></div>
        <div class="pill"><div class="big" id="hum">-- %</div><div style="font-size:12px;color:var(--muted)">Humidity</div></div>
      </div>
    </div>

<canvas id="chart"></canvas>
<script>
const maxPoints = 288; // keep device buffer alignment
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { 
        label: 'Temperature (°C)', 
        data: [], 
        borderColor: '#fb7185', 
        tension: 0.35, 
        pointRadius: 2, 
        borderWidth: 2, 
        yAxisID: 'y' 
      },
      { 
        label: 'Humidity (%)', 
        data: [], 
        borderColor: '#60a5fa', 
        tension: 0.35, 
        pointRadius: 2, 
        borderWidth: 2, 
        yAxisID: 'y1' 
      }
    ]
  },
  options: {
    responsive: true,
    animation: { duration: 600, easing: 'easeOutCubic' },
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: true, position: 'bottom', labels: { color: '#e6eef8' } },
      tooltip: {
        mode: 'index',
        intersect: false,
        callbacks: {
          label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}`
        }
      }
    },
    scales: {
      x: { 
        display: true, 
        ticks: { color: '#e6eef8' },
        grid: { color: 'rgba(255,255,255,0.05)' }
      },
      y: { 
        position: 'left', 
        beginAtZero: false, 
        ticks: { color: '#fb7185' }, 
        grid: { color: 'rgba(255,255,255,0.1)' } 
      },
      y1: { 
        position: 'right', 
        beginAtZero: false, 
        ticks: { color: '#60a5fa' }, 
        grid: { drawOnChartArea: false } 
      }
    }
  }
});

function trim() {
  while(chart.data.labels.length > maxPoints) {
    chart.data.labels.shift();
    chart.data.datasets.forEach(ds => ds.data.shift());
  }
}

async function refresh() {
  try {
    const r = await fetch('/api/update');
    if (!r.ok) throw 0;
    const d = await r.json();

    // update top cards
    document.getElementById('temp').textContent = d.t.toFixed(1) + ' °C';
    document.getElementById('hum').textContent = d.h.toFixed(1) + ' %';
    document.getElementById('updated').textContent = 'Updated: ' + new Date(d.time).toLocaleTimeString();

    // push to chart
    chart.data.labels.push(new Date(d.time).toLocaleTimeString());
    chart.data.datasets[0].data.push(d.t);
    chart.data.datasets[1].data.push(d.h);
    trim();
    chart.update();
  } catch(e) {
    document.getElementById('updated').textContent = 'Offline / no live update';
  }
}

(async function init() {
  setInterval(refresh, 2000); // live poll every 2s
})();
</script>

</body>
</html>
